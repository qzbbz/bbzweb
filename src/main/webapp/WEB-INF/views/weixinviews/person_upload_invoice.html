<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<title></title>
		<link href="/css/weixincss/mui.min.css" rel="stylesheet" />
		<link href="/css/weixincss/iconfont.css" rel="stylesheet" />
		<link href="/css/weixincss/circle-progress.css" rel="stylesheet" />
		<link href="/css/weixincss/mui.picker.min.css" rel="stylesheet" />
		<link href="/css/weixincss/mui.poppicker.css" rel="stylesheet" />
		<style>
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100%;
				height: auto;
			}
			.upload-file {
				position: fixed;
				z-index: 998;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				background-color: rgba(0, 0, 0, .8);
			}
			.dialog {
				position: fixed;
				z-index: 998;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				background-color: rgba(0, 0, 0, .4);
			}
			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 999;
				margin-top: 60px;
			}
			
			.mui-table-view.mui-grid-view .mui-table-view-cell{
				display:inline !important;
			}
			
			.info {
				width:inherit !important;
			}
			
			.mui-pull-left{
				width: 180px;
				height: 120px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">个人发票上传</h1>
		</header>
		<div class="mui-content">
			<div class="mui-card" id="company_select" style="margin:10px 5px;height:40px;line-height:40px;">
				<div class="mui-pull-left" style="height:40px;width:30%;"><p style="margin-left: 15px;">公司名称</p></div>
				<div class="mui-pull-right" style="height:40px;width:70%;">
					<span id="companyName" style="color:#8f8f94;"></span><span class="mui-icon mui-icon-arrowright" style="font-size: 20px;margin-top:0px;color:#8f8f94;display:inline-block"></span>
					<input id="userId" type="hidden" class="mui-input-clear" value="">
				</div>
			</div>
			<div class="mui-card" style="margin:10px 5px;height:40px;line-height:40px;">
				<p id="total_amount" style="margin-left: 15px;">发票总额： 0元</p>
			</div>
			<div id="data_loading" class="mui-loading" style="margin-top:50%;">
				<div class="mui-spinner"></div>
				<div style="text-align: center;">正在加载数据</div>
			</div>
			<div id="tips_info" style="display:none;margin-top:50%;">
				<div style="text-align: center;" id="tips_info_detail">服务器暂时无法处理请求，请稍后重试！</div>
			</div>
			<!-- <div id="company_select" class="mui-input-row" style="background-color:white;width:100%;height:40px;margin-top:15px;display:none;">
                <label style="width:25%;margin-top:3px;">公司:</label>
                <input id="companyName" type="text" class="mui-input-clear" style="width:75%;" value="" placeholder="" readOnly>
            	<input id="userId" type="hidden" class="mui-input-clear" value="">
            </div>	 -->	
			<div class="mui-card" id="add_invoice_page" style="display:none;z-index:15;margin:10px 0px;width:100%;height:80px;line-height: 80px;">
							
				<div style="background-color: white;height:70px;margin-top:5px;margin-left: 5px;" class="mui-pull-left">
					<div style="background-color: white;height:70px;">
						<p style="margin-top: -5px;margin-left: 10px;">添加发票图像</p>
					</div>
				</div>
				<div class="mui-pull-right" style="margin-top:5px;" id="os_andr">
					<!-- <input id="fapiaoluru_addInvoiceImage" type="file" accept="image/*;capture=camera" multiple="true" hidefocus='true' style="position: absolute;float:right;width:50px;height:50px;opacity: 0;"> -->
					<!-- <span class="mui-icon iconfont icon-tianjia" style="font-size: 70px;color:#C3C3C6;margin-top:-10px;margin-right:5px;"></span> -->
				</div>
			</div>
			<div id="tips_image" class="mui-control-content mui-active" style="display:none;height:260px;">
				<ul class="mui-table-view mui-grid-view">
					<li class="mui-table-view-cell mui-media mui-col-xs-12">
						<img class="mui-media-object" src="../../img/weixinimg/empty_invoice.png">
					</li>
				</ul>
			</div>
			<div id="invoice_img_list_root_div" style="display:none;margin-bottom:45px;height:100%;">
				<div id="scroll">
					<div class="">
						<ul class="mui-table-view" id="invoice_img_list_ul"></ul>
					</div>
				</div>
			</div>
		</div>
		<footer id="fapiaoluru_submit" class="mui-bar mui-bar-footer" style="display:none;"><h1 class="mui-title">上传发票</h1></footer>
	</body>
	<script src="../../js/weixinjs/mui.min.js"></script>
	<script src="../../js/weixinjs/mui.previewimage.js"></script>
	<script src="../../js/weixinjs/mui.zoom.min.js"></script>
	<script src="../../js/weixinjs/jquery-1.11.1.min.js"></script>
	<script src="../../js/weixinjs/circle-progress.js"></script>
	<script src="/js/weixinjs/mui.picker.min.js"></script>
	<script src="/js/weixinjs/mui.poppicker.min.js"></script>
	<!-- <script src="../../js/weixinjs/person_upload_invoice.js?201806260945"></script> -->
	<script>
	
	var companyPicker = new mui.PopPicker();
	function checkJsonIsEmpty(json) {
		var isEmpty = true;
		if(json == null) return true;
		for (var jsonKey in json) {
			isEmpty = false;
			break;
		}
		return isEmpty;
	}

	mui.createUploadMask = function(callback) {
		var element = document.createElement('div');
		element.classList.add('upload-file');	
		element.addEventListener('touchmove', mui.preventDefault);
		element.addEventListener('tap', function() {
			//mask.close();
		});
		var progressNode = document.createElement('div');
		progressNode.id="upload_progress";
		progressNode.setAttribute('class', 'circle');
		progressNode.innerHTML = "<strong></strong>";
		element.appendChild(progressNode);
		var mask = [element];
		mask._show = false;
		mask.show = function() {
			mask._show = true;
			element.setAttribute('style', 'opacity:1');
			progressNode.style.marginLeft = document.body.clientWidth/2-50 + "px";
			progressNode.style.marginTop = document.documentElement.clientHeight /2 -50 + "px";
			document.body.appendChild(element);
			$('#upload_progress').circleProgress({
		    	value: 0,
		    	emptyFill: 'rgba(74, 197, 248, 1)',
		    	animation: false,
		    	fill: { gradient: ["red", "blue", "green"], gradientAngle: Math.PI / 4 }	
		    }).on('circle_progress_percent', function(event, progress) {
		        $(this).find('strong').html(parseInt(100 * progress) + '<i>%</i>');
		        $('#upload_progress').circleProgress('value', progress);
		    });
			return mask;
		};
		mask._remove = function() {
			if (mask._show) {
				mask._show = false;
				element.setAttribute('style', 'opacity:0');
				mui.later(function() {
					var body = document.body;
					element.parentNode === body && body.removeChild(element);
				}, 350);
			}
			return mask;
		};
		mask.close = function() {
			if (callback) {
				if (callback() !== false) {
					mask._remove();
				}
			} else {
				mask._remove();
			}
		};
		return mask;
	};

	mui.createTipDialog = function(info, callBack) {
		var template = "<div style='width:80%;margin:50% 10%;border:1px solid #ddd;background-color: white;border-radius: 5px;'><div style='margin-top:20px;margin-left:20px;'>提示信息</div><hr/><div style='margin-top:20px;margin-left:20px;margin-bottom:20px;margin-right:20px;height:60px;'>{{info}}</div></div>";
		var element = document.createElement('div');
		element.classList.add('dialog');
		element.innerHTML = template.replace('{{info}}', info);
		element.addEventListener('touchmove', mui.preventDefault);
		element.addEventListener('tap', function() {
			mask.close();
		});
		var mask = [element];
		mask._show = false;
		mask.show = function() {
			mask._show = true;
			element.setAttribute('style', 'opacity:1');
			document.body.appendChild(element);
			return mask;
		};
		mask._remove = function() {
			if (mask._show) {
				mask._show = false;
				element.setAttribute('style', 'opacity:0');
				mui.later(function() {
					var body = document.body;
					element.parentNode === body && body.removeChild(element);
				}, 350);
			}
			return mask;
		};
		mask.close = function() {
			if (callBack) {
				callBack();
			}
			mask._remove();
		};
		return mask;
	};

	mui.createConfirmDialog = function(info, cancelCallBack, acceptCallBack) {
		var template = "<div style='width:80%;margin:50% 10%;border:1px solid #ddd;background-color: white;border-radius: 5px;'><div style='margin-top:20px;margin-left:20px;'>提示信息</div><hr/><div style='margin-top:20px;margin-left:20px;margin-bottom:20px;margin-right:20px;height:60px;'>{{info}}</div><div style='text-align:right;margin-bottom:20px;margin-right:20px;'><a id='createConfirmDialog_cancel' href='javascript:void(0);' style='margin-right:20px;text-decoration:none;'>取消</a><a id='createConfirmDialog_accept' href='javascript:void(0);' style='text-decoration:none;'>确定</a></div></div>";
		var element = document.createElement('div');
		element.classList.add('dialog');
		element.innerHTML = template.replace('{{info}}', info);
		element.addEventListener('touchmove', mui.preventDefault);
		var mask = [element];
		mask._show = false;
		mask.show = function() {
			mask._show = true;
			element.setAttribute('style', 'opacity:1');
			document.body.appendChild(element);
			document.getElementById('createConfirmDialog_cancel').addEventListener('tap', function() {
				if (cancelCallBack) cancelCallBack();
				mask.close();
			});
			document.getElementById('createConfirmDialog_accept').addEventListener('tap', function() {
				if (acceptCallBack) acceptCallBack();
				mask.close();
			});
			return mask;
		};
		mask._remove = function() {
			if (mask._show) {
				mask._show = false;
				element.setAttribute('style', 'opacity:0');
				mui.later(function() {
					var body = document.body;
					element.parentNode === body && body.removeChild(element);
				}, 350);
			}
			return mask;
		};
		mask.close = function() {
			mask._remove();
		};
		return mask;
	};

	mui.createFillInfoDialog = function(info, cancelFillInCallBack, acceptFillInCallBack){
		var template = "<div style='width:80%;margin:50% 10%;border:1px solid #ddd;background-color: white;border-radius: 5px;'><div style='margin-top:20px;margin-left:20px;'>提示信息</div><hr/><div style='margin-top:20px;margin-left:20px;margin-bottom:20px;margin-right:20px;height:60px;'>{{info}}</div><div style='text-align:right;margin-bottom:20px;margin-right:20px;'><a id='createFillInDialog_cancel' href='javascript:void(0);' style='margin-right:20px;text-decoration:none;'>取消</a><a id='createFillInDialog_accept' href='javascript:void(0);' style='text-decoration:none;'>确定</a></div></div>";
		var element = document.createElement('div');
		element.classList.add('dialog');
		element.innerHTML = template.replace('{{info}}', info);
		element.addEventListener('touchmove', mui.preventDefault);
		var mask = [element];
		mask._show = false;
		mask.show = function() {
			mask._show = true;
			element.setAttribute('style', 'opacity:1');
			document.body.appendChild(element);
			document.getElementById('createFillInDialog_cancel').addEventListener('tap', function() {
				if (cancelCallBack) cancelCallBack();
				mask.close();
			});
			document.getElementById('createFillInDialog_accept').addEventListener('tap', function() {
				if (acceptCallBack) acceptCallBack();
				mask.close();
			});
			return mask;
		};
		mask._remove = function() {
			if (mask._show) {
				mask._show = false;
				element.setAttribute('style', 'opacity:0');
				mui.later(function() {
					var body = document.body;
					element.parentNode === body && body.removeChild(element);
				}, 350);
			}
			return mask;
		};
		mask.close = function() {
			mask._remove();
		};
		return mask;
	}

	mui.init();
	mui('.mui-scroll-wrapper').scroll();
	mui.initPreviewImage();
	mui.previewImage({
		isUpload: true
	});

	var userOpenId = "";



	function getImageDataURL(img) {
		var canvas = document.createElement('canvas');
		canvas.width = img.width;
		canvas.height = img.height;
		var context = canvas.getContext('2d');
		context.drawImage(img, 0, 0);
		var dataURL = canvas.toDataURL('image/png');
		return dataURL;
	}

	function fillInInformation(){
		console.log(this);
		mui.createFillInfoDialog("hola", null).show();
	}
	var invoiceTypePicker = new mui.PopPicker();
	mui.ajax({
		type: "POST",
		url: "/getAllExpenseTypes",
		data: {},
		success : function(data){
			if(!checkJsonIsEmpty(data)) {
				var expenseType = new Array();
				for(var key in data) {
					expenseType.push({value:key,text:data[key]});
				}
				invoiceTypePicker.setData(expenseType);
			}
		}		
	});

	var inputIndex = 0;
	


	function bindRightSliderEvent() {
		$(".invoice_cancel").each(function(){
			$(this).on("click", function(){
				var curEle = this;
				mui.createConfirmDialog('您确定要删除当前发票吗？',
						function(){},
						function(){
							try{
								var imgSrc = $(curEle).parent().find("img").attr("src");
								if(imgSrc in invoiceList){
									delete invoiceList[imgSrc];
								}


							}catch(e){
								console.log(e);
							}
							$(curEle).parent().remove();
							var amount = 0;
							$(".fapiaoluru_amount").each(function(){
								var elem = parseFloat($(this).val());
								
								if(!isNaN(elem)){
									amount += elem;
								}

							});
							amount = amount.toFixed(2);
							$("#total_amount").html("发票总额： " + amount + "元");
						}
					).show();
			});
		});
	}

	document.getElementById('fapiaoluru_submit').addEventListener('tap', function(event) {
		var isEmpty = true;
		for (var jsonKey in invoiceList) {
			isEmpty = false;
			break;
		}
		if (isEmpty) {
			mui.createTipDialog('您还没有添加发票图像，请先添加!',null).show();
			return;
		}
		var mask = mui.createUploadMask(false);

		$('#upload_progress').find('strong').html(0 + '<i>%</i>');
		var amounts = document.getElementsByClassName('fapiaoluru_amount');
		var types = document.getElementsByClassName('fapiaoluru_type');
		var typesStr = "";
		var amountsStr = "";
		for(var i=0; i<amounts.length; i++) {
			if(isNaN(amounts[i].value) || amounts[i].value == "") {
				mui.createTipDialog('上传的发票金额必须为数字且不能为空，请检查!',null).show();
				return;
			}
			amountsStr += amounts[i].value + ";";
			if(parseInt(amounts[i].value) <= 0) {
				mui.createTipDialog('上传的发票金额必须不小于0，请检查!',null).show();
				return;
			}
		}
		for(var i=0; i<types.length; i++) {
			if(types[i].innerHTML == "选择") {
				mui.createTipDialog('上传的发票类型必须指定，请检查!',null).show();
				return;
			}
			typesStr += types[i].innerHTML + ";";
		}
		mask.show();
		var formData = {userId:$('#userId').val(), expense_amount:amountsStr, expense_type:typesStr};
		var xhr = new XMLHttpRequest();
		var fd = new FormData();
		for (var jsonKey in formData) {
			fd.append(jsonKey, formData[jsonKey]);
		}
		for (var jsonKey in invoiceList) {
			fd.append("files", invoiceList[jsonKey]);
		}
		xhr.upload.addEventListener("progress", function(evt) {
			if (evt.lengthComputable) {
				var percentComplete = Math.round(evt.loaded * 100 / evt.total) / 100;
				$('#upload_progress').trigger('circle_progress_percent', [percentComplete]);
			}
		}, false);
		xhr.addEventListener("load", function(evt) {
			var res = evt.target.responseText;
			res = JSON.parse(res);
			if (res.error_code == "0") {
				mui.createTipDialog('发票上传成功!',null).show();
				invoiceList = {};
				totalCount = 0;
				document.getElementById('tips_image').style.display = "";
				document.getElementById('invoice_img_list_ul').innerText = "";
				document.getElementById('invoice_img_list_root_div').style.display = "none";
			} else {
				mui.createTipDialog(res.error_message, null).show();
			}
			mask.close();
		}, false);
		xhr.addEventListener("error", function(evt) {
			mui.createTipDialog('发票上传失败!，请稍后重试',null).show();
			mask.close();
		}, false);
		xhr.addEventListener("abort", null, false);
		xhr.open("POST", "/uploadPersonInvoice");
		xhr.send(fd);
	}, false);
	/*document.getElementById("data_loading").style.display = "none";
	document.getElementById("add_invoice_page").style.display = "";
	document.getElementById("tips_image").style.display = "";
	document.getElementById("fapiaoluru_submit").style.display = "";*/
	document.getElementById('company_select').addEventListener('tap', function() {
		companyPicker.show(function(rs) {
			document.getElementById('companyName').innerHTML = rs[0].text;
			document.getElementById('userId').value = rs[0].value;
		});
	}, false);

	mui.ajax({ 
	    type : "POST", 
	    url  : "/getUserOpenIdAndCheckBindCompany",
	    data : {type:"0"}, 
	    success : function(data) {
	    	if (data.error_code != '0') {
				mui.createTipDialog(data.error_msg,null).show();
				document.getElementById("data_loading").style.display = "none";
				document.getElementById("tips_info_detail").innerHTML = data.error_msg + ",<br/>请稍后重试！";
		    	document.getElementById("tips_info").style.display = "";
			} else {
				userOpenId = data.openId;
				if(data.bind_status == "has_bind") {
					console.log(data);
					companyPicker.setData(data.companyName);
					document.getElementById('companyName').innerHTML = data.default_company;
		    		document.getElementById('userId').value = data.default_userid;
					document.getElementById("data_loading").style.display = "none";
					document.getElementById("add_invoice_page").style.display = "";
					document.getElementById("tips_image").style.display = "";
					document.getElementById("fapiaoluru_submit").style.display = "";
					document.getElementById("company_select").style.display = "";
				} else {
					document.getElementById("data_loading").style.display = "none";
					document.getElementById("tips_info_detail").innerHTML = "您还没有绑定公司，<br/>请先在账号设置中绑定您的公司！";
			    	document.getElementById("tips_info").style.display = "";
				}
			}
	    }, 
	    error : function() {
	    	mui.createTipDialog('服务器暂时无法响应请求，请稍后重试！',null).show();
	    	document.getElementById("data_loading").style.display = "none";
	    	document.getElementById("tips_info_detail").innerHTML = "服务器暂时无法响应请求，<br/>请稍后重试！";
	    	document.getElementById("tips_info").style.display = "";
	    } 
	});
	window.onload = function () {
	    var u = navigator.userAgent;
	    if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1) {//安卓手机
	    	$("#os_andr").prepend("<input id='fapiaoluru_addInvoiceImage' type='file' capture='camera' accept='image/*' multiple='true' hidefocus='true' style='position: absolute;float:right;width:50px;height:50px;opacity: 0;'><span class='mui-icon iconfont icon-tianjia' style='font-size: 70px;color:#C3C3C6;margin-top:0px;margin-right:5px;'></span>");
	    // window.location.href = "mobile/index.html";
	    } else if (u.indexOf('iPhone') > -1) {//苹果手机
	    // window.location.href = "mobile/index.html";
	    	$("#os_andr").prepend("<input id='fapiaoluru_addInvoiceImage' type='file' accept='image/*;capture=camera' multiple='true' hidefocus='true' style='position: absolute;float:right;width:50px;height:50px;opacity: 0;'><span class='mui-icon iconfont icon-tianjia' style='font-size: 70px;color:#C3C3C6;margin-top:-10px;margin-right:5px;'></span>");
	    } else if (u.indexOf('Windows Phone') > -1) {//winphone手机
	    	$("#os_andr").prepend("<input id='fapiaoluru_addInvoiceImage' type='file' capture='camera' accept='image/*;' multiple='true' hidefocus='true' style='position: absolute;float:right;width:50px;height:50px;opacity: 0;'>");
	    }
	    document.getElementById("fapiaoluru_addInvoiceImage").onchange = function(event) {
			inputIndex = inputIndex + 1;
			document.getElementById('tips_image').style.display = 'none';
			document.getElementById('invoice_img_list_root_div').style.display = '';
			/*document.getElementById('invoice_img_list_root_div').style.height = window.screen.availHeight - 198 + "px";*/
			var imageRootNode = document.getElementById('invoice_img_list_ul');	
			/*var liNode = document.createElement('li');
			liNode.setAttribute("class", "mui-media mui-table-view-cell");
			var imgNode = document.createElement('img');
			imgNode.setAttribute('class', 'mui-pull-left');
			imgNode.setAttribute('data-preview-group', '1');
			imgNode.setAttribute('data-preview-src', '');
			imgNode.style.width = '100px';
			imgNode.style.height = '80px';
			imgNode.style.maxWidth = '100px';
			liNode.appendChild(imgNode);
			var inputRootNode = document.createElement('div');
			inputRootNode.setAttribute('class', 'mui-media-body');
			var inputAmountNode = document.createElement('div');
			inputAmountNode.style.marginTop = "0px";
			inputAmountNode.style.marginLeft = "5px";
			inputAmountNode.style.height = "45px";
			inputAmountNode.style.color = "#8f8f94";
			//inputAmountNode.innerHTML = "发票金额:<span class='mui-pull-right' ><span class='fapiaoluru_amount' id='fapiaoluru_amount_"+inputIndex+"'>0</span><span class='mui-icon mui-icon-arrowright' style='font-size: 20px;margin-top:0px;display:inline-block'></span></span>";
			inputAmountNode.innerHTML = "<span>发票金额:</span><span class='mui-pull-right' style='height:20px;'><input class='fapiaoluru_amount' type='text' style='width:100%;height:20px;padding-top:0px;padding-bottom:0px;'/></span>";
			var inputTypeNode = document.createElement('div');
			inputTypeNode.style.marginTop = "5px";
			inputTypeNode.style.marginLeft = "5px";
			inputTypeNode.style.color = "#8f8f94";
			inputTypeNode.innerHTML = "发票类型:<span class='mui-pull-right' ><span class='fapiaoluru_type' id='fapiaoluru_type_"+inputIndex+"'>选择</span><span class='mui-icon mui-icon-arrowright' style='font-size: 20px;margin-top:0px;display:inline-block'></span></span>";
			inputRootNode.appendChild(inputAmountNode);
			inputRootNode.appendChild(inputTypeNode);
			liNode.appendChild(inputRootNode);
			inputTypeNode.addEventListener('tap', function(event) {
				var ele = this.childNodes[1].childNodes[0];
				invoiceTypePicker.show(function(items) {
					ele.innerText = items[0].text;
				});
			}, false);
			imageRootNode.appendChild(liNode);*/
			var files = event.target.files,
				file;
			if (files && files.length > 0) {
				for(var i=0; i<files.length; i++) {
					var liNode = document.createElement('li');
					liNode.setAttribute("class", "mui-media mui-table-view-cell");
					liNode.innerHTML = "<div class='mui-slider-right mui-disabled invoice_cancel'><a class='mui-btn mui-btn-red'>作废</a></div>";
					var slideNode = document.createElement('div');
					slideNode.setAttribute('class', 'mui-slider-handle');
					var imgNode = document.createElement('img');
					imgNode.setAttribute('class', 'mui-pull-left');
					imgNode.setAttribute('data-preview-group', '1');
					imgNode.setAttribute('data-preview-src', '');
					imgNode.style.width = '100px';
					imgNode.style.height = '80px';
					imgNode.style.maxWidth = '100px';
					slideNode.appendChild(imgNode);
					var inputRootNode = document.createElement('div');
					inputRootNode.setAttribute('class', 'mui-media-body');
					var inputAmountNode = document.createElement('div');
					inputAmountNode.style.marginTop = "0px";
					inputAmountNode.style.marginLeft = "5px";
					inputAmountNode.style.height = "45px";
					inputAmountNode.style.color = "#8f8f94";
					//inputAmountNode.innerHTML = "发票金额:<span class='mui-pull-right' ><span class='fapiaoluru_amount' id='fapiaoluru_amount_"+inputIndex+"'>0</span><span class='mui-icon mui-icon-arrowright' style='font-size: 20px;margin-top:0px;display:inline-block'></span></span>";
					inputAmountNode.innerHTML = "<span>发票金额:</span><span class='mui-pull-right' style='height:30px;'><input class='fapiaoluru_amount' type='text' style='width:100px;height:30px;padding-top:0px;padding-bottom:0px;'/></span>";
					var inputTypeNode = document.createElement('div');
					inputTypeNode.style.marginTop = "5px";
					inputTypeNode.style.marginLeft = "5px";
					inputTypeNode.style.color = "#8f8f94";
					inputTypeNode.innerHTML = "发票类型:<span class='mui-pull-right' ><span class='fapiaoluru_type' id='fapiaoluru_type_"+inputIndex+"'>选择</span><span class='mui-icon mui-icon-arrowright' style='font-size: 20px;margin-top:0px;display:inline-block'></span></span>";
					inputRootNode.appendChild(inputAmountNode);
					inputRootNode.appendChild(inputTypeNode);

					slideNode.appendChild(inputRootNode);
					//liNode.innerHTML += "</div>";
					liNode.appendChild(slideNode);
					inputTypeNode.addEventListener('tap', function(event) {
						var ele = this.childNodes[1].childNodes[0];
						invoiceTypePicker.show(function(items) {
							ele.innerText = items[0].text;
						});
					}, false);
					imageRootNode.appendChild(liNode);				
					file = files[i];
					$(".fapiaoluru_amount").keyup(function(){
						var amount = 0;
						$(".fapiaoluru_amount").each(function(){
							var elem = parseFloat($(this).val());
							
							if(!isNaN(elem)){
								amount += elem;
							}

						});
						amount = amount.toFixed(2);
						$("#total_amount").html("发票总额： " + amount + "元");
					});
					try {
						var URL = window.URL || window.webkitURL;
						imgURL = URL.createObjectURL(file);
						imgNode.src = imgURL;
						invoiceList[imgURL] = file;//document.getElementById('fapiaoluru_addInvoiceImage').files[0];
						//URL.revokeObjectURL(imgURL);
					} catch (e) {
						try {
							var fileReader = new FileReader();
							fileReader.onload = function(event) {
								imgNode.src = event.target.result;
								invoiceList[imgNode.src] = file;//document.getElementById('fapiaoluru_addInvoiceImage').files[0];
							};
							fileReader.readAsDataURL(file);
						} catch (e) {
							alert("Neither createObjectURL or FileReader are supported");
						}
					}
				}
			}
			console.log(invoiceList);
			bindRightSliderEvent();
		}
	}
	</script>
</html>